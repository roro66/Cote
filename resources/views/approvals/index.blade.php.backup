<x-app-layout>
    <x-slot name="header">
        <div class="flex justify-between items-center">
            <h2 class="font-semibold text-xl text-gray-800 dark:text-gray-200 leading-tight">
                Panel de Aprobaciones
            </h2>
        </div>
    </x-slot>

    <div class="py-12">
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
            
            <!-- Transacciones Pendientes -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm sm:rounded-lg mb-6">
                <div class="p-6 text-gray-900 dark:text-gray-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="h4">Transacciones Pendientes ({{ $pendingTransactions->count() }})</h3>
                    </div>

                    @if($pendingTransactions->count() > 0)
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Tipo</th>
                                        <th>Desde</th>
                                        <th>Hacia</th>
                                        <th>Monto</th>
                                        <th>Descripción</th>
                                        <th>Solicitado por</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach($pendingTransactions as $transaction)
                                    <tr>
                                        <td>{{ $transaction->transaction_number }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ $transaction->type_spanish }}</span>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ $transaction->fromAccount->name }}</strong>
                                                <small class="text-muted d-block">
                                                    {{ $transaction->fromAccount->type_spanish }}
                                                    @if($transaction->fromAccount->person)
                                                        - {{ $transaction->fromAccount->person->full_name }}
                                                    @endif
                                                </small>
                                                <small class="text-success">
                                                    Saldo: {{ $transaction->fromAccount->balance_formatted }}
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ $transaction->toAccount->name }}</strong>
                                                <small class="text-muted d-block">
                                                    {{ $transaction->toAccount->type_spanish }}
                                                    @if($transaction->toAccount->person)
                                                        - {{ $transaction->toAccount->person->full_name }}
                                                    @endif
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            <strong class="text-primary">{{ $transaction->amount_formatted }}</strong>
                                        </td>
                                        <td>{{ $transaction->description }}</td>
                                        <td>
                                            {{ $transaction->createdBy->name }}
                                            <small class="text-muted d-block">{{ $transaction->created_at->diffForHumans() }}</small>
                                        </td>
                                        <td>{{ $transaction->created_at->format('d/m/Y H:i') }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-success btn-sm" 
                                                        onclick="approveTransaction({{ $transaction->id }})"
                                                        title="Aprobar">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm" 
                                                        onclick="showRejectModal({{ $transaction->id }}, 'transaction')"
                                                        title="Rechazar">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    @endforeach
                                </tbody>
                            </table>
                        </div>
                    @else
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No hay transacciones pendientes de aprobación.
                        </div>
                    @endif
                </div>
            </div>

            <!-- Rendiciones Pendientes -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm sm:rounded-lg">
                <div class="p-6 text-gray-900 dark:text-gray-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="h4">Rendiciones Pendientes ({{ $pendingExpenses->count() }})</h3>
                    </div>

                    @if($pendingExpenses->count() > 0)
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Cuenta</th>
                                        <th>Monto Total</th>
                                        <th>Descripción</th>
                                        <th>Enviado por</th>
                                        <th>Fecha Gasto</th>
                                        <th>Fecha Envío</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach($pendingExpenses as $expense)
                                    <tr>
                                        <td>{{ $expense->expense_number }}</td>
                                        <td>
                                            <div>
                                                <strong>{{ $expense->account->name }}</strong>
                                                <small class="text-muted d-block">
                                                    @if($expense->account->person)
                                                        {{ $expense->account->person->full_name }}
                                                    @else
                                                        {{ $expense->account->type_spanish }}
                                                    @endif
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            <strong class="text-primary">{{ $expense->total_amount_formatted }}</strong>
                                        </td>
                                        <td>{{ $expense->description }}</td>
                                        <td>
                                            {{ $expense->submittedBy->full_name }}
                                            <small class="text-muted d-block">{{ $expense->submitted_at->diffForHumans() }}</small>
                                        </td>
                                        <td>{{ $expense->expense_date->format('d/m/Y') }}</td>
                                        <td>{{ $expense->submitted_at->format('d/m/Y H:i') }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-info btn-sm" 
                                                        onclick="viewExpense({{ $expense->id }})"
                                                        title="Ver Detalles">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-success btn-sm" 
                                                        onclick="approveExpense({{ $expense->id }})"
                                                        title="Aprobar">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm" 
                                                        onclick="showRejectModal({{ $expense->id }}, 'expense')"
                                                        title="Rechazar">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    @endforeach
                                </tbody>
                            </table>
                        </div>
                    @else
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No hay rendiciones pendientes de aprobación.
                        </div>
                    @endif
                </div>
            </div>

        </div>
    </div>

    <!-- Modal para Rechazo -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rechazar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="rejectForm">
                        <div class="mb-3">
                            <label for="rejection_reason" class="form-label">Motivo del Rechazo *</label>
                            <textarea class="form-control" id="rejection_reason" name="rejection_reason" 
                                    rows="3" placeholder="Ingrese el motivo del rechazo..." required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmReject()">Rechazar</button>
                </div>
            </div>
        </div>
    </div>

    @push('scripts')
    <script>
    // Configurar Toastr
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "timeOut": "3000"
    };

    let currentItemId = null;
    let currentItemType = null;

    // Aprobar transacción
    function approveTransaction(id) {
        if (confirm('¿Está seguro de que desea aprobar esta transacción?')) {
            $.ajax({
                url: `/approvals/transactions/${id}/approve`,
                method: 'POST',
                data: {
                    _token: '{{ csrf_token() }}'
                },
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        location.reload();
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function(xhr) {
                    const response = xhr.responseJSON;
                    toastr.error(response.message || 'Error al aprobar la transacción');
                }
            });
        }
    }

    // Aprobar rendición
    function approveExpense(id) {
        if (confirm('¿Está seguro de que desea aprobar esta rendición?')) {
            $.ajax({
                url: `/approvals/expenses/${id}/approve`,
                method: 'POST',
                data: {
                    _token: '{{ csrf_token() }}'
                },
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        location.reload();
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function(xhr) {
                    const response = xhr.responseJSON;
                    toastr.error(response.message || 'Error al aprobar la rendición');
                }
            });
        }
    }

    // Mostrar modal de rechazo
    function showRejectModal(id, type) {
        currentItemId = id;
        currentItemType = type;
        $('#rejection_reason').val('');
        $('#rejectModal').modal('show');
    }

    // Confirmar rechazo
    function confirmReject() {
        const reason = $('#rejection_reason').val().trim();
        if (!reason) {
            toastr.error('Debe ingresar un motivo de rechazo');
            return;
        }

        const url = currentItemType === 'transaction' 
            ? `/approvals/transactions/${currentItemId}/reject`
            : `/approvals/expenses/${currentItemId}/reject`;

        $.ajax({
            url: url,
            method: 'POST',
            data: {
                _token: '{{ csrf_token() }}',
                rejection_reason: reason
            },
            success: function(response) {
                if (response.success) {
                    toastr.success(response.message);
                    $('#rejectModal').modal('hide');
                    location.reload();
                } else {
                    toastr.error(response.message);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                toastr.error(response.message || 'Error al rechazar');
            }
        });
    }

    // Ver detalles de rendición (placeholder)
    function viewExpense(id) {
        // TODO: Implementar vista de detalles
        toastr.info('Vista de detalles en desarrollo...');
    }
    </script>
    @endpush
</x-app-layout>
                                <tr>
                                    <th>#</th>
                                    <th>Número</th>
                                    <th>Tipo</th>
                                    <th>Cuenta Origen</th>
                                    <th>Cuenta Destino</th>
                                    <th>Monto</th>
                                    <th>Descripción</th>
                                    <th>Creado por</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles -->
    <div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionModalLabel">Detalles de Transacción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="transactionDetails">
                    <!-- Los detalles se cargarán aquí -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" id="approveBtn">
                        <i class="fas fa-check"></i> Aprobar
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectBtn">
                        <i class="fas fa-times"></i> Rechazar
                    </button>
                </div>
            </div>
        </div>
    </div>

    @push('scripts')
    <script>
    let currentTransactionId = null;

    $(document).ready(function() {
        // Inicializar DataTable para Aprobaciones (solo pendientes)
        let table = $('#approvals-table').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{{ route('datatables.transactions') }}",
                data: function (d) {
                    d.status = 'pending'; // Solo mostrar pendientes
                }
            },
            columns: [
                {data: 'DT_RowIndex', name: 'DT_RowIndex', orderable: false, searchable: false},
                {data: 'transaction_number', name: 'transaction_number'},
                {data: 'type_spanish', name: 'type_spanish'},
                {data: 'from_account_name', name: 'from_account_name'},
                {data: 'to_account_name', name: 'to_account_name'},
                {data: 'amount_formatted', name: 'amount_formatted', className: 'text-end'},
                {data: 'description', name: 'description'},
                {data: 'creator_name', name: 'creator_name'},
                {data: 'created_at_formatted', name: 'created_at_formatted'},
                {data: 'action', name: 'action', orderable: false, searchable: false}
            ],
            language: {
                "decimal": "",
                "emptyTable": "No hay datos disponibles en la tabla",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered": "(filtrado de _MAX_ entradas totales)",
                "infoPostFix": "",
                "thousands": ".",
                "lengthMenu": "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing": "Procesando...",
                "search": "Buscar:",
                "zeroRecords": "No se encontraron registros coincidentes",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            },
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'copy',
                    text: '<i class="fas fa-copy"></i> Copiar',
                    className: 'btn btn-secondary btn-sm'
                },
                {
                    extend: 'excel',
                    text: '<i class="fas fa-file-excel"></i> Excel',
                    className: 'btn btn-secondary btn-sm',
                    filename: 'transacciones_pendientes_' + new Date().toISOString().split('T')[0]
                },
                {
                    extend: 'pdf',
                    text: '<i class="fas fa-file-pdf"></i> PDF',
                    className: 'btn btn-secondary btn-sm',
                    filename: 'transacciones_pendientes_' + new Date().toISOString().split('T')[0],
                    title: 'Transacciones Pendientes - COTESO',
                    orientation: 'landscape'
                }
            ],
            responsive: true,
            pageLength: 25,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
            order: [[8, 'desc']], // Ordenar por fecha descendente
            columnDefs: [
                { targets: [0, 9], orderable: false }
            ],
            scrollX: true
        });

        // Manejar aprobación
        $('#approveBtn').on('click', function() {
            if (currentTransactionId && confirm('¿Está seguro de que desea aprobar esta transacción?')) {
                $.ajax({
                    url: '/transactions/' + currentTransactionId + '/approve',
                    method: 'POST',
                    data: {
                        _token: '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        $('#transactionModal').modal('hide');
                        table.ajax.reload();
                        toastr.success('Transacción aprobada exitosamente');
                    },
                    error: function() {
                        toastr.error('Error al aprobar la transacción');
                    }
                });
            }
        });

        // Manejar rechazo
        $('#rejectBtn').on('click', function() {
            let reason = prompt('¿Cuál es el motivo del rechazo?');
            if (currentTransactionId && reason !== null) {
                $.ajax({
                    url: '/transactions/' + currentTransactionId + '/reject',
                    method: 'POST',
                    data: {
                        _token: '{{ csrf_token() }}',
                        reason: reason
                    },
                    success: function(response) {
                        $('#transactionModal').modal('hide');
                        table.ajax.reload();
                        toastr.success('Transacción rechazada');
                    },
                    error: function() {
                        toastr.error('Error al rechazar la transacción');
                    }
                });
            }
        });
    });

    // Funciones globales para las acciones
    function viewTransaction(id) {
        currentTransactionId = id;
        
        // Cargar detalles de la transacción
        $.ajax({
            url: '/transactions/' + id,
            method: 'GET',
            success: function(response) {
                $('#transactionDetails').html(response);
                $('#transactionModal').modal('show');
            },
            error: function() {
                toastr.error('Error al cargar los detalles de la transacción');
            }
        });
    }

    function approveTransaction(id) {
        if (confirm('¿Está seguro de que desea aprobar esta transacción?')) {
            $.ajax({
                url: '/transactions/' + id + '/approve',
                method: 'POST',
                data: {
                    _token: '{{ csrf_token() }}'
                },
                success: function(response) {
                    $('#approvals-table').DataTable().ajax.reload();
                    toastr.success('Transacción aprobada exitosamente');
                },
                error: function() {
                    toastr.error('Error al aprobar la transacción');
                }
            });
        }
    }

    function rejectTransaction(id) {
        let reason = prompt('¿Cuál es el motivo del rechazo?');
        if (reason !== null) {
            $.ajax({
                url: '/transactions/' + id + '/reject',
                method: 'POST',
                data: {
                    _token: '{{ csrf_token() }}',
                    reason: reason
                },
                success: function(response) {
                    $('#approvals-table').DataTable().ajax.reload();
                    toastr.success('Transacción rechazada');
                },
                error: function() {
                    toastr.error('Error al rechazar la transacción');
                }
            });
        }
    }
    </script>
    @endpush
</x-app-layout>
